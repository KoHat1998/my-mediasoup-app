<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Livenix • Player</title>
  <style>
    html,body{height:100%;margin:0;background:#0B0E19;color:#e9f2ff;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    .wrap{display:flex;flex-direction:column;min-height:100%}
    header{padding:10px 14px;border-bottom:1px solid #1e2536;display:flex;gap:10px;align-items:center}
    header .pill{background:#ff337d;color:#fff;padding:4px 10px;border-radius:999px;font-weight:700}
    main{flex:1;display:flex;align-items:center;justify-content:center;padding:12px}
    video{width:min(100vw,100%);max-height:75vh;background:#000;border-radius:12px}
    footer{padding:8px 14px;border-top:1px solid #1e2536;display:flex;justify-content:space-between;font-size:12px;opacity:.85}
    #err{color:#ff8aa8;font-weight:600}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <span id="live" class="pill">CONNECTING…</span>
    <div id="title" style="font-weight:700">Viewer</div>
    <div style="margin-left:auto;opacity:.8" id="host"></div>
  </header>

  <main>
    <video id="v" playsinline autoplay controls muted></video>
  </main>

  <footer>
    <div id="err"></div>
    <div><small>Tip: tap Unmute if audio is blocked.</small></div>
  </footer>
</div>

<script src="/socket.io/socket.io.js"></script>
<script type="module">
  import * as mediasoupClient from 'https://esm.sh/mediasoup-client@3';

  const qs   = new URLSearchParams(location.search);
  const slug = qs.get('slug') || qs.get('id') || qs.get('room') || '';
  const rawToken = qs.get('token') || '';
  const token = rawToken ? (/^Bearer\s/i.test(rawToken) ? rawToken : `Bearer ${rawToken}`) : '';

  const $live = document.getElementById('live');
  const $v    = document.getElementById('v');
  const $err  = document.getElementById('err');
  const $title= document.getElementById('title');

  function setLive(text, bad=false) {
    $live.textContent = text;
    $live.style.background = bad ? '#ff285f' : '#22c55e';
  }

  if (!slug) {
    setLive('NO SLUG', true);
    $err.textContent = 'Missing ?slug in URL';
    throw new Error('Missing slug');
  }
  $title.textContent = 'Viewer: ' + slug;

  // Socket.IO: websocket only (avoids polling/CORS headaches in WebView)
  const socket = io('/', {
    transports: ['websocket'],
    auth: { role: 'viewer', token, slug },
  });

  socket.on('connect', start).on('connect_error', (e) => {
    setLive('CONNECT ERROR', true);
    $err.textContent = e?.message || String(e);
  });

  async function start() {
    try {
      setLive('CONNECTING…');
      const rtpCaps = await emitAck('getRtpCapabilities', null);
      const device = new mediasoupClient.Device();
      await device.load({ routerRtpCapabilities: rtpCaps });

      const tInfo = await emitAck('createRecvTransport', null);
      const recvTransport = device.createRecvTransport(tInfo);
      recvTransport.on('connect', ({ dtlsParameters }, cb, err) =>
        emitAck('connectRecvTransport', { dtlsParameters }).then(cb).catch(err)
      );

      async function consume(kind) {
        const res = await emitAck('consume', { rtpCapabilities: device.rtpCapabilities, kind });
        if (res?.error) throw new Error(res.error);
        const consumer = await recvTransport.consume({
          id: res.id, producerId: res.producerId, kind: res.kind, rtpParameters: res.rtpParameters
        });
        await emitAck('resume', { consumerId: consumer.id });
        if (kind === 'video') $v.srcObject = new MediaStream([consumer.track]);
      }

      try { await consume('video'); } catch (e) { console.warn('no video yet', e); }
      try { await consume('audio'); } catch (e) { console.warn('no audio yet', e); }

      setLive('LIVE');

      socket.on('newProducer', async (p) => {
        try { await consume(p.kind); } catch (e) { console.warn('consume on newProducer failed', e); }
      });

    } catch (e) {
      setLive('ERROR', true);
      $err.textContent = e?.message || String(e);
      console.error(e);
    }
  }

  function emitAck(event, payload) {
    return new Promise((resolve, reject) => {
      socket.timeout(8000).emit(event, payload, (res) => {
        if (res && res.error) return reject(new Error(res.error));
        resolve(res);
      });
    });
  }
</script>
</body>
</html>