<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Livenix â€¢ Player</title>
  <style>
    html,body{height:100%;margin:0;background:#0B0E19;color:#E9F2FF;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{display:flex;flex-direction:column;min-height:100%}
    header{display:none}                 /* hide legacy header row */

    /* let the video touch the edges */
    main{flex:0;padding:0;margin:0}

    #err{color:#ff8aa8;font-weight:600}

    /* Stage and HUD */
    .stage{position:relative;display:block;width:100vw}
    /* Full-bleed video, no rounding */
    video{
      display:block;
      width:100vw;
      height:56.25vw;        /* 16:9 from width */
      max-height:75vh;       /* leave room for chat below */
      background:#000;
      border-radius:0;
      object-fit:cover;
      position:relative; z-index:1;
    }
    .hud{
      position:absolute; right:8px; top:8px;
      display:flex; gap:8px; align-items:center;
      z-index:2; /* above video */
    }
    .pill{
      background:#22c55e;color:#fff;padding:4px 10px;border-radius:999px;
      font-weight:700;letter-spacing:.2px;font-size:12px
    }
    .counter{
      background:rgba(0,0,0,.55);color:#fff;padding:4px 10px;border-radius:999px;
      font-weight:600;font-size:12px;display:flex;align-items:center;gap:6px
    }
    .counter .dot{width:6px;height:6px;border-radius:999px;background:#22c55e}

    /* Unmute overlay */

    .unmute span{
      background:#111; color:#fff; padding:10px 14px;
      border-radius:999px; font-weight:700; font-size:14px;
      border:1px solid rgba(255,255,255,.2);
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <span id="legacy-live" class="pill">CONNECTINGâ€¦</span>
    <div id="title" style="font-weight:700">Viewer</div>
    <div style="margin-left:auto;opacity:.8" id="host"></div>
  </header>

  <main>
    <div class="stage">
      <video id="v" playsinline autoplay controls muted></video>

      <!-- HUD inside video area -->
      <div class="hud">
        <span id="live" class="pill">CONNECTINGâ€¦</span>
        <span id="views" class="counter" style="display:inline-flex">
          <span class="dot"></span><span id="viewsTxt">0</span>
        </span>
      </div>

      <!-- Unmute overlay -->
      <div class="unmute" id="unmute" aria-label="Tap to unmute">
        <span>ðŸ”Š Unmute</span>
      </div>
    </div>
  </main>

  <div id="err" style="padding:8px 14px;"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script type="module">
  import * as mediasoupClient from 'https://esm.sh/mediasoup-client@3';

  // --- Query params from Flutter ---
  const qs   = new URLSearchParams(location.search);
  const slug = qs.get('slug') || qs.get('id') || qs.get('room') || '';
  const rawToken = qs.get('token') || '';
  const token = rawToken ? (/^Bearer\s/i.test(rawToken) ? rawToken : `Bearer ${rawToken}`) : '';

  // --- DOM refs ---
  const $live     = document.getElementById('live');
  const $v        = document.getElementById('v');
  const $err      = document.getElementById('err');
  const $title    = document.getElementById('title'); // header hidden; guard anyway
  const $views    = document.getElementById('views');
  const $viewsTxt = document.getElementById('viewsTxt');
  const $unmute   = document.getElementById('unmute');

  function setLive(text, bad=false){
    $live.textContent = text;
    $live.style.background = bad ? '#ff285f' : '#22c55e';
  }
  function showUnmute(){ if ($unmute) $unmute.style.display = 'flex'; }
  function hideUnmute(){ if ($unmute) $unmute.style.display = 'none'; }

  if (!slug) {
    setLive('NO SLUG', true);
    $err.textContent = 'Missing ?slug in URL';
    throw new Error('Missing slug');
  }
  const passedTitle = qs.get('title') || slug;
  if ($title) $title.textContent = 'Title: ' + passedTitle;

  // Websocket-only transport (WebView-friendly)
  const socket = io('/', {
    transports: ['websocket'],
    auth: { role: 'viewer', token, slug }
  });

  socket.on('connect', start);
  socket.on('connect_error', (e) => {
    setLive('CONNECT ERROR', true);
    $err.textContent = e?.message || String(e);
  });

  // ðŸ‘ live updates when server broadcasts viewer count
  socket.on('viewers', (n) => {
    if ($views)    $views.style.display = 'inline-flex';
    if ($viewsTxt) $viewsTxt.textContent = String(n ?? 0);
  });

  // Try unmute on any user gesture (mobile autoplay policy)
  ['click','pointerdown','touchstart'].forEach(ev => {
    window.addEventListener(ev, async () => {
      try { $v.muted = false; await $v.play(); hideUnmute(); } catch {}
    }, { passive:true });
  });
  if ($unmute) {
    $unmute.addEventListener('click', async () => {
      try { $v.muted = false; await $v.play(); hideUnmute(); } catch {}
    });
  }
  $v.addEventListener('volumechange', () => {
    if ($v.muted || $v.volume === 0) showUnmute(); else hideUnmute();
  });

  async function start() {
    try {
      setLive('CONNECTINGâ€¦');

      // 1) Router RTP caps
      const rtpCaps = await emitAck('getRtpCapabilities', null);
      if (!rtpCaps || !Array.isArray(rtpCaps.codecs)) {
        throw new Error('No RTP capabilities from server');
      }

      const device = new mediasoupClient.Device();
      await device.load({ routerRtpCapabilities: rtpCaps });

      // 2) Create recv transport
      const tInfo = await emitAck('createRecvTransport', null);
      const recvTransport = device.createRecvTransport(tInfo);
      recvTransport.on('connect', ({ dtlsParameters }, cb, err) =>
        emitAck('connectRecvTransport', { dtlsParameters }).then(cb).catch(err)
      );

      // 3) Consume helper â€” attach both audio & video to SAME MediaStream
      async function consume(kind) {
        const res = await emitAck('consume', { rtpCapabilities: device.rtpCapabilities, kind });
        if (res?.error) throw new Error(res.error);

        const consumer = await recvTransport.consume({
          id: res.id,
          producerId: res.producerId,
          kind: res.kind,
          rtpParameters: res.rtpParameters
        });
        await emitAck('resume', { consumerId: consumer.id });

        let ms = ($v.srcObject instanceof MediaStream) ? $v.srcObject : new MediaStream();
        ms.addTrack(consumer.track);
        $v.srcObject = ms;

        try { await $v.play(); } catch { showUnmute(); }
        return consumer;
      }

      // 4) Start media
      try { await consume('video'); } catch {}
      try { await consume('audio'); } catch {}

      setLive('LIVE');
      if ($v.muted) showUnmute();

      // 5) React to producers appearing later
      socket.on('newProducer', async (p) => {
        try { await consume(p.kind); } catch {}
      });

      // ðŸ‘ initial viewer count
      try {
        const { count } = await emitAck('getViewerCount', null);
        if ($views)    $views.style.display = 'inline-flex';
        if ($viewsTxt && typeof count === 'number') $viewsTxt.textContent = String(count);
      } catch (e) {
        console.warn('getViewerCount failed:', e?.message || e);
      }

    } catch (e) {
      setLive('ERROR', true);
      $err.textContent = e?.message || String(e);
      console.error(e);
    }
  }

  // Strict ack with timeout
  function emitAck(event, payload) {
    return new Promise((resolve, reject) => {
      socket.timeout(8000).emit(event, payload, (err, res) => {
        if (err) return reject(new Error('timeout'));
        if (res && res.error) return reject(new Error(res.error));
        if (res == null) return reject(new Error('no response'));
        resolve(res);
      });
    });
  }
</script>
</body>
</html>
