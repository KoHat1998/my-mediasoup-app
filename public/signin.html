<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sign in · KoHat Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="header">
    <a href="/" class="brand">🎥 KoHat Live</a>
    <div class="actions">
      <a class="btn ghost" href="/signup.html">Create account</a>
    </div>
  </header>

  <main class="main" style="max-width:620px;margin:0 auto">
    <section class="card" style="padding:24px">
      <h1 style="margin:0 0 6px">Welcome back</h1>
      <p class="small" style="opacity:.9;margin:0 0 16px">
        Sign in to watch and host live streams.
      </p>

      <form id="f" autocomplete="on">
        <label class="label">Email</label>
        <input class="input" type="email" name="email" placeholder="you@example.com" required />

        <label class="label" style="margin-top:12px">Password</label>
        <input class="input" type="password" name="password" required />

        <div style="display:flex;gap:10px;align-items:center;margin-top:16px;flex-wrap:wrap">
          <button id="submitBtn" class="btn" type="submit">Sign in</button>
          <span id="msg" class="small" style="opacity:.9"></span>
        </div>
      </form>

      <div style="margin-top:20px;text-align:center">
        <button id="guestBtn" class="btn ghost" type="button">Continue as Guest (test)</button>
      </div>
    </section>
  </main>

  <footer class="footer">
    <small>© 2025 KoHat Live</small>
    <nav>
      <a href="#">Terms</a>
      <a href="#">Privacy</a>
      <a href="#">Contact</a>
    </nav>
  </footer>

  <script>
    const API_LOGIN = 'https://livenix.duckdns.org/api/login';

    const form = document.getElementById('f');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('submitBtn');
    const guestBtn = document.getElementById('guestBtn');

    form.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.style.color = '';
      btn.disabled = true;

      const body = Object.fromEntries(new FormData(form));

      try {
        const res = await fetch(API_LOGIN, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ email: body.email, password: body.password })
        });

        let data = {};
        try { data = await res.json(); } catch {}

        if (!res.ok) {
          const firstError =
            data.message ||
            (data.errors && Object.values(data.errors)[0]?.[0]) ||
            'Invalid email or password';
          msg.textContent = `❌ ${firstError}`;
          msg.style.color = 'red';
          btn.disabled = false;
          return;
        }

        // Normalize token: Laravel usually returns { access_token, token_type, user }
        const access = data.access_token || data.token || '';
        const type   = (data.token_type || 'Bearer').trim();
        const bearer = access ? `${type} ${access}` : '';

        // Save under BOTH keys so every page reads it consistently
        if (bearer) {
          localStorage.setItem('token', bearer);       // many of our pages expect this
          localStorage.setItem('authToken', bearer);   // previous code used this
        }
        if (data.user) {
          localStorage.setItem('user', JSON.stringify(data.user));
        }

        // Redirect immediately (no delay) and prevent back button to sign-in
        msg.textContent = '✅ Login successful! Redirecting…';
        msg.style.color = 'green';
        location.replace('/lives.html');

        // Fallback in case replace is blocked for some reason
        setTimeout(() => {
          if (!/lives\.html$/.test(location.pathname)) {
            location.href = '/lives.html';
          }
        }, 600);
      } catch (err) {
        msg.textContent = 'Network error. Please try again.';
        msg.style.color = 'red';
        btn.disabled = false;
      }
    };

    // Guest shortcut (for testing without backend)
    guestBtn.onclick = () => {
      const fake = 'Bearer TEST_FAKE_TOKEN';
      localStorage.setItem('token', fake);
      localStorage.setItem('authToken', fake);
      localStorage.setItem('user', JSON.stringify({ email: 'tester@example.com' }));
      location.replace('/lives.html');
    };
  </script>
</body>
</html>