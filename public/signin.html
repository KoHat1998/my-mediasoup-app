<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sign in · Livenix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="stylesheet" href="/style.css" />
  <link rel="icon" href="/favicon.ico" />
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="/" class="brand" aria-label="Livenix home">
      <img src="/assets/livenix.svg" alt="" style="height:22px;vertical-align:middle;margin-right:6px" onerror="this.style.display='none'">
      Livenix
    </a>
    <div class="actions">
      <a class="btn ghost" href="/signup.html">Create account</a>
    </div>
  </header>

  <!-- Main -->
  <main class="main" style="max-width:500px;margin:0 auto;">
    <section class="card" style="padding:28px; border-radius:12px;">
      <h1 style="margin:0 0 10px; font-size:1.6rem;">Welcome back</h1>
      <p class="small" style="opacity:.8; margin:0 0 20px;">
        Sign in to watch and host live streams on <strong>Livenix</strong>.
      </p>

      <form id="f" autocomplete="on">
        <label class="label">Email</label>
        <input class="input" type="email" name="email" id="email" placeholder="you@example.com" required />

        <label class="label" style="margin-top:14px;">Password</label>
        <input class="input" type="password" name="password" id="password" placeholder="••••••••" required />

        <div style="display:flex; gap:12px; align-items:center; margin-top:20px; flex-wrap:wrap;">
          <button id="submitBtn" class="btn" type="submit" style="flex:1;">Sign in</button>
          <span id="msg" class="small" style="opacity:.9"></span>
        </div>
      </form>

      <div style="margin-top:24px; text-align:center;">
        <button id="guestBtn" class="btn ghost" type="button" style="width:100%;">
          Continue as Guest (test)
        </button>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <small>© 2025 Livenix</small>
    <nav style="display:flex; gap:14px;">
      <a href="#">Terms</a>
      <a href="#">Privacy</a>
      <a href="#">Contact</a>
    </nav>
  </footer>

  <script>
    const API_LOGIN = 'https://livenix.duckdns.org/api/login';

    const form = document.getElementById('f');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('submitBtn');
    const guestBtn = document.getElementById('guestBtn');

    form.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.style.color = '';
      btn.disabled = true;

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      try {
        const res = await fetch(API_LOGIN, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });

        let data = {};
        try { data = await res.json(); } catch {}

        if (!res.ok) {
          const firstError =
            data.message ||
            (data.errors && Object.values(data.errors)[0]?.[0]) ||
            'Invalid email or password';
          msg.textContent = `❌ ${firstError}`;
          msg.style.color = 'red';
          btn.disabled = false;
          return;
        }

        const access = data.access_token || data.token || '';
        const type   = (data.token_type || 'Bearer').trim();
        const bearer = access ? `${type} ${access}` : '';

        if (bearer) {
          localStorage.setItem('token', bearer);
          localStorage.setItem('authToken', bearer);
        }
        if (data.user) {
          localStorage.setItem('user', JSON.stringify(data.user));
        }

        msg.textContent = '✅ Login successful! Redirecting…';
        msg.style.color = 'green';
        location.replace('/lives.html');

        setTimeout(() => {
          if (!/lives\.html$/.test(location.pathname)) {
            location.href = '/lives.html';
          }
        }, 800);
      } catch (err) {
        console.error('Login error:', err);
        msg.textContent = 'Network error. Please try again.';
        msg.style.color = 'red';
      } finally {
        btn.disabled = false;
      }
    };

    guestBtn.onclick = () => {
      const fake = 'Bearer TEST_FAKE_TOKEN';
      localStorage.setItem('token', fake);
      localStorage.setItem('authToken', fake);
      localStorage.setItem('user', JSON.stringify({ email: 'guest@example.com' }));
      location.replace('/lives.html');
    };
  </script>
</body>
</html>